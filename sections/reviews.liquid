{% comment %}
  Reviews section - Displays Yotpo reviews in a carousel layout
{% endcomment %}

<div class="reviews-section full-width" id="reviews-section-{{ section.id }}">
  {%- comment -%} Background Color Block - Outside container for full width {%- endcomment -%}
  <div class="reviews-section__bg-block"></div>

  <div class="reviews-section__container">
    {%- comment -%} Heading {%- endcomment -%}
    {% if section.settings.heading != blank %}
      <h2 class="reviews-section__heading">{{ section.settings.heading }}</h2>
    {% endif %}

    {%- comment -%} View All Button {%- endcomment -%}
    {% if section.settings.view_all_url != blank %}
      <a href="{{ section.settings.view_all_url }}" class="reviews-section__view-all">
        <span>{{ section.settings.view_all_text | default: 'VIEW ALL' }}</span>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="13"
          height="22"
          viewBox="0 0 13 22"
          fill="none">
          <path
            d="M0.707031 0.707031L10.707 10.707L0.707031 20.707"
            stroke="#3E2027"
            stroke-width="2" />
        </svg>
      </a>
    {% endif %}

    {%- comment -%} Reviews Carousel {%- endcomment -%}
    <div class="reviews-section__carousel" data-reviews-carousel>
      <div class="reviews-section__track" data-reviews-track>
        {%- comment -%} Yotpo Reviews Container {%- endcomment -%}
        <div class="reviews-section__yotpo-container" id="yotpo-reviews-{{ section.id }}">
          {%- comment -%} Yotpo widget will load here {%- endcomment -%}
          <div
            class="yotpo yotpo-reviews-carousel"
            data-appkey="{{ section.settings.yotpo_app_key }}"
            data-domain="{{ shop.domain }}"
            data-product-id="{{ section.settings.product_id | default: 'site' }}"
            data-name="{{ shop.name }}"
            data-url="{{ shop.url }}"></div>
        </div>

        {%- comment -%} Fallback/Sample Reviews (if Yotpo not loaded) {%- endcomment -%}
        {% if section.blocks.size > 0 %}
          <div class="reviews-section__cards" data-reviews-cards>
            {% for block in section.blocks %}
              {% if block.type == 'review' %}
                <div class="reviews-section__card" {{ block.shopify_attributes }}>
                  <div class="reviews-section__card-header">
                    <p class="reviews-section__card-name">{{ block.settings.reviewer_name }}</p>
                    <p class="reviews-section__card-date">{{ block.settings.review_date }}</p>
                  </div>
                  <p class="reviews-section__card-text">{{ block.settings.review_text }}</p>
                  <div class="reviews-section__card-stars">
                    {% for i in (1..5) %}
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="14"
                        height="13"
                        viewBox="0 0 14 13"
                        fill="none">
                        <path d="M6.3512 0.196596C6.38042 0.13757 6.42555 0.087884 6.4815 0.0531459C6.53746 0.0184078 6.60201 0 6.66787 0C6.73373 0 6.79828 0.0184078 6.85423 0.0531459C6.91019 0.087884 6.95532 0.13757 6.98453 0.196596L8.52453 3.31593C8.62599 3.52124 8.77574 3.69887 8.96095 3.83356C9.14616 3.96826 9.36129 4.056 9.58787 4.08926L13.0319 4.59326C13.0971 4.60272 13.1584 4.63024 13.2089 4.67273C13.2593 4.71521 13.2968 4.77096 13.3172 4.83367C13.3376 4.89637 13.34 4.96353 13.3243 5.02755C13.3085 5.09157 13.2751 5.1499 13.2279 5.19593L10.7372 7.62126C10.5729 7.78133 10.45 7.97892 10.3791 8.19701C10.3081 8.41511 10.2912 8.64719 10.3299 8.87326L10.9179 12.2999C10.9294 12.3652 10.9223 12.4323 10.8975 12.4937C10.8727 12.5551 10.8312 12.6083 10.7776 12.6473C10.724 12.6862 10.6605 12.7093 10.5944 12.7139C10.5284 12.7185 10.4623 12.7044 10.4039 12.6733L7.3252 11.0546C7.12235 10.9481 6.89665 10.8924 6.66753 10.8924C6.43841 10.8924 6.21272 10.9481 6.00987 11.0546L2.93187 12.6733C2.87342 12.7042 2.80747 12.7181 2.7415 12.7134C2.67554 12.7087 2.61221 12.6856 2.55873 12.6467C2.50525 12.6078 2.46376 12.5547 2.43897 12.4934C2.41419 12.4321 2.40711 12.3651 2.41853 12.2999L3.00587 8.87393C3.04466 8.64775 3.02786 8.41553 2.95689 8.19729C2.88593 7.97906 2.76294 7.78136 2.59853 7.62126L0.107866 5.1966C0.0602624 5.15062 0.0265286 5.09219 0.0105081 5.02798C-0.00551242 4.96376 -0.00317558 4.89634 0.0172523 4.83339C0.0376802 4.77044 0.0753778 4.71449 0.126051 4.67192C0.176724 4.62935 0.238335 4.60186 0.303866 4.5926L3.7472 4.08926C3.97404 4.05626 4.18946 3.96863 4.37492 3.83392C4.56039 3.69921 4.71034 3.52144 4.81187 3.31593L6.3512 0.196596Z" fill="#3E2027" />
                      </svg>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}
      </div>

      {%- comment -%} Navigation Arrows {%- endcomment -%}
      <button
        type="button"
        class="reviews-section__arrow reviews-section__arrow--prev"
        aria-label="{{ 'general.previous' | t }}"
        data-reviews-prev>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="13"
          height="22"
          viewBox="0 0 13 22"
          fill="none">
          <path
            d="M11.4142 0.707031L1.41418 10.707L11.4142 20.707"
            stroke="#3E2027"
            stroke-width="2" />
        </svg>
      </button>

      <button
        type="button"
        class="reviews-section__arrow reviews-section__arrow--next"
        aria-label="{{ 'general.next' | t }}"
        data-reviews-next>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="13"
          height="22"
          viewBox="0 0 13 22"
          fill="none">
          <path
            d="M0.707031 0.707031L10.707 10.707L0.707031 20.707"
            stroke="#3E2027"
            stroke-width="2" />
        </svg>
      </button>
    </div>
  </div>
</div>

{% stylesheet %}
  .reviews-section {
    background-color: #FFF7EA;
    padding: 0;
    position: relative;
    overflow: hidden;
  }

  /* Background Color Block - Full width, positioned absolutely */
  .reviews-section__bg-block {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 600px;
    background-color: #FCF0D2;
    z-index: 0;
  }

  .reviews-section__container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 70px 40px 100px;
    position: relative;
    z-index: 1;
  }

  /* Heading */
  .reviews-section__heading {
    font-family: var(--font-alyona);
    font-size: 70px;
    font-weight: 400;
    line-height: 1;
    color: #3E2027;
    margin: 0 0 90px;
    position: relative;
  }

  /* View All Button */
  .reviews-section__view-all {
    position: absolute;
    right: 40px;
    top: 98px;
    display: flex;
    align-items: center;
    gap: 15px;
    font-family: var(--font-sweet-sans);
    font-weight: 500;
    font-size: 18px;
    line-height: normal;
    letter-spacing: -0.18px;
    text-transform: uppercase;
    color: #3E2027;
    text-decoration: none;
    z-index: 2;
    transition: opacity 0.2s ease
    , transform 0.2s ease;
  }

  .reviews-section__view-all:hover {
    opacity: 0.8;
    transform: translateX(2px);
  }

  .reviews-section__view-all svg {
    width: 6px;
    height: 12px;
    flex-shrink: 0;
  }

  /* Carousel */
  .reviews-section__carousel {
    position: relative;
    overflow: hidden;
    padding: 0 40px;
  }

  .reviews-section__track {
    position: relative;
    width: 100%;
    overflow: hidden;
  }

  /* Hide Yotpo default container, use custom cards */
  .reviews-section__yotpo-container {
    display: none;
  }

  /* Reviews Cards */
  .reviews-section__cards {
    display: flex;
    gap: 35px;
    transition: transform 0.4s ease;
    will-change: transform;
  }

  /* Individual Review Card */
  .reviews-section__card {
    flex: 0 0 367px;
    width: 367px;
    min-height: 150px;
    border-left: 1px solid #3E2027;
    padding: 10px 0 15px 30px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    background-color: transparent;
  }

  /* Card Header - Name and Date */
  .reviews-section__card-header {
    display: flex;
    align-items: center;
    gap: 20px;
    flex-shrink: 0;
  }

  .reviews-section__card-name {
    font-family: var(--font-sweet-sans);
    font-weight: 500;
    font-size: 18px;
    line-height: normal;
    letter-spacing: -0.18px;
    text-transform: uppercase;
    color: #3E2027;
    margin: 0;
    white-space: nowrap;
  }

  .reviews-section__card-date {
    font-family: var(--font-jokker);
    font-size: 14px;
    line-height: 1.5;
    color: #3E2027;
    opacity: 0.4;
    margin: 0;
    white-space: nowrap;
  }

  /* Card Review Text */
  .reviews-section__card-text {
    font-family: var(--font-jokker);
    font-size: 16px;
    line-height: 1.5;
    color: #3E2027;
    margin: 0;
    flex: 1;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }

  /* Star Rating */
  .reviews-section__card-stars {
    display: flex;
    gap: 5.09px;
    align-items: center;
    flex-shrink: 0;
    margin-top: auto;
  }

  .reviews-section__card-stars svg {
    width: 15px;
    height: 15px;
    flex-shrink: 0;
  }

  /* Navigation Arrows - Centered vertically with cards */
  .reviews-section__arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 10px;
    height: 20px;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 0;
    z-index: 3;
    transition: opacity 0.2s ease
    , transform 0.2s ease;
  }

  .reviews-section__arrow:hover {
    opacity: 0.7;
  }

  .reviews-section__arrow:active {
    opacity: 0.5;
  }

  .reviews-section__arrow:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .reviews-section__arrow--prev {
    left: 0;
  }

  .reviews-section__arrow--next {
    right: 0;
  }

  .reviews-section__arrow svg {
    width: 100%;
    height: 100%;
    display: block;
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .reviews-section__container {
      padding: 70px 24px 80px;
    }

    .reviews-section__heading {
      margin-bottom: 50px;
    }

    .reviews-section__view-all {
      right: 24px;
      top: 73px;
    }

    .reviews-section__carousel {
      padding: 0 35px;
    }

    .reviews-section__card {
      flex: 0 0 340px;
      width: 340px;
    }

    .reviews-section__cards {
      gap: 25px;
    }
  }

  @media (max-width: 768px) {
    .reviews-section__bg-block {
      height: 350px;
    }

    .reviews-section__container {
      padding: 50px 16px 60px;
    }

    .reviews-section__heading {
      font-size: 50px;
      margin-bottom: 40px;
    }

    .reviews-section__view-all {
      right: 16px;
      top: 53px;
      font-size: 16px;
      gap: 10px;
    }

    .reviews-section__carousel {
      padding: 0 30px;
    }

    .reviews-section__card {
      flex: 0 0 280px;
      width: 280px;
      min-height: 160px;
      padding: 10px 0 15px 20px;
    }

    .reviews-section__card-name {
      font-size: 16px;
    }

    .reviews-section__card-date {
      font-size: 12px;
    }

    .reviews-section__card-text {
      font-size: 14px;
    }

    .reviews-section__cards {
      gap: 20px;
    }
  }

  @media (max-width: 480px) {
    .reviews-section__heading {
      font-size: 40px;
    }

    .reviews-section__carousel {
      padding: 0 25px;
    }

    .reviews-section__card {
      flex: 0 0 250px;
      width: 250px;
      padding: 10px 0 15px 16px;
    }

    .reviews-section__card-name {
      font-size: 14px;
    }

    .reviews-section__card-text {
      font-size: 13px;
    }
  }
{% endstylesheet %}

{% javascript %}
  class ReviewsCarousel {
    constructor(container) {
      this.container = container;
      this.carousel = container.querySelector('.reviews-section__carousel');
      this.track = container.querySelector('[data-reviews-track]');
      this.cardsContainer = container.querySelector('[data-reviews-cards]');
      this.cards = container.querySelectorAll('.reviews-section__card');
      this.prevBtn = container.querySelector('[data-reviews-prev]');
      this.nextBtn = container.querySelector('[data-reviews-next]');
      this.currentIndex = 0;
      this.cardsToShow = this.getCardsToShow();

      if (!this.cardsContainer || this.cards.length === 0) {
        console.log('No review cards found');
        return;
      }

      if (this.cards.length<= this.cardsToShow) {
        this.hideArrows();
        return;
      }

      this.init();
      this.setupResizeHandler();
    }

    init() {
      this.updateCarousel();
      
      if (this.prevBtn) {
        this.prevBtn.addEventListener('click', () => {
        console.log('Prev clicked, current index:', this.currentIndex);
        this.prev();
      }) 


      


    }

    if (this.nextBtn) {
      this.nextBtn.addEventListener('click', () => {
        console.log('Next clicked, current index:', this.currentIndex);
        this.next();
      });
    }

// Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') 
        this.prev();
      


      if (e.key === 'ArrowRight') 
        this.next();
      


    });
  }

  getCardsToShow() {
    const width = window.innerWidth;
    if (width <= 480) 
      return1;
    


    if (width <= 768) 
      return2;
    


    if (width <= 1200) 
      return2;
    


    return 3;
  }

  updateCarousel() {
    if (!this.cardsContainer || this.cards.length === 0) return;
    


    const cardWidth = this.cards[0].offsetWidth;
    const gap = parseFloat(getComputedStyle(this.cardsContainer).gap) || 35;
    const offset = -(this.currentIndex * (cardWidth + gap));

    console.log('Updating carousel:', {
      currentIndex: this.currentIndex,
      cardWidth,
      gap,
      offset,
      totalCards: this.cards.length,
      cardsToShow: this.cardsToShow
    });

    this.cardsContainer.style.transform = `translateX(${offset}px)`;

// Update button states
    if (this.prevBtn) {
      this.prevBtn.disabled = this.currentIndex === 0;
    }
    if (this.nextBtn) {
      const maxIndex = Math.max(0, this.cards.length - this.cardsToShow);
      this.nextBtn.disabled = this.currentIndex >= maxIndex;
    }
  }

  next() {
    const maxIndex = Math.max(0, this.cards.length - this.cardsToShow);
    if (this.currentIndex<maxIndex) {
        this.currentIndex++;
        this.updateCarousel();
      }
    }

    prev() {
      if (this.currentIndex> 0) {
      this.currentIndex --;
      this.updateCarousel();
    }
  }

  hideArrows() {
    if (this.prevBtn) 
      this.prevBtn.style.display = 'none';
    


    if (this.nextBtn) 
      this.nextBtn.style.display = 'none';
    


  }

  setupResizeHandler() {
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        const newCardsToShow = this.getCardsToShow();
        if (newCardsToShow !== this.cardsToShow) {
          this.cardsToShow = newCardsToShow;
          this.currentIndex = Math.min(this.currentIndex, Math.max(0, this.cards.length - this.cardsToShow));
          this.updateCarousel();
        }
      }, 150);
    });
  }
}

// Initialize on page load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initReviews);
} else {
  initReviews();
}

function initReviews () {
  const reviewsSections = document.querySelectorAll('[data-reviews-carousel]');
  reviewsSections.forEach(section => {
    new ReviewsCarousel(section);
  });
}

// Yotpo integration - Load Yotpo script and initialize
(function() {
  const yotpoAppKey = document.querySelector('.yotpo-reviews-carousel') ?. getAttribute('data-appkey');

  if (yotpoAppKey && typeof yotpo === 'undefined') {
    const script = document.createElement('script');
    script.type = 'text/javascript';
    script.async = true;
    script.src = `//staticw2.yotpo.com/${yotpoAppKey}/widget.js`;
    document.head.appendChild(script);
  } else if (typeof yotpo !== 'undefined') { // Yotpo already loaded, refresh widgets
    yotpo.refreshWidgets();
  }
})();
{% endjavascript %}

{% schema %}
  {
    "name": "t:general.reviews",
    "class": "reviews-section-wrapper",
    "settings": [
      {
        "type": "header",
        "content": "t:sections.reviews.content_header"
      },
      {
        "type": "text",
        "id": "heading",
        "label": "t:labels.heading",
        "default": "Reviews"
      },
      {
        "type": "header",
        "content": "t:sections.reviews.view_all_header"
      },
      {
        "type": "text",
        "id": "view_all_text",
        "label": "t:labels.view_all_text",
        "default": "VIEW ALL"
      }, {
        "type": "url",
        "id": "view_all_url",
        "label": "t:labels.view_all_url",
        "info": "t:sections.reviews.view_all_info"
      }, {
        "type": "header",
        "content": "t:sections.reviews.yotpo_header"
      }, {
        "type": "text",
        "id": "yotpo_app_key",
        "label": "t:labels.yotpo_app_key",
        "info": "t:sections.reviews.yotpo_app_key_info"
      }, {
        "type": "product",
        "id": "product_id",
        "label": "t:labels.product",
        "info": "t:sections.reviews.product_info"
      }
    ],
    "blocks": [
      {
        "type": "review",
        "name": "t:blocks.review.name",
        "settings": [
          {
            "type": "text",
            "id": "reviewer_name",
            "label": "t:labels.reviewer_name",
            "default": "Reviewer Name"
          }, {
            "type": "text",
            "id": "review_date",
            "label": "t:labels.review_date",
            "default": "06/2025"
          }, {
            "type": "textarea",
            "id": "review_text",
            "label": "t:labels.review_text",
            "default": "This product exceeded my expectations!"
          }
        ]
      }
    ],
    "presets": [
      {
        "name": "t:general.reviews",
        "blocks": [
          {
            "type": "review",
            "settings": {
              "reviewer_name": "Mia T.",
              "review_date": "06/2025",
              "review_text": "My husband literally said, 'Wait, why do you smell like nothing?' Best compliment ever."
            }
          }, {
            "type": "review",
            "settings": {
              "reviewer_name": "Lucas M.",
              "review_date": "06/2025",
              "review_text": "I've tried every natural deo out there â€” this is the first thing that actually works."
            }
          }, {
            "type": "review",
            "settings": {
              "reviewer_name": "Mia T.",
              "review_date": "06/2025",
              "review_text": "Didn't expect a pre-deodorant to change my life, but here we are."
            }
          }, {
            "type": "review",
            "settings": {
              "reviewer_name": "Sarah K.",
              "review_date": "06/2025",
              "review_text": "This product exceeded my expectations!"
            }
          }
        ]
      }
    ]
  }
{% endschema %}