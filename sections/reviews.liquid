{% comment %}
  Reviews section - Displays Yotpo reviews in a carousel layout
{% endcomment %}

<div class="reviews-section full-width" id="reviews-section-{{ section.id }}">
  {%- comment -%} Background Color Block - Outside container for full width {%- endcomment -%}
  <div class="reviews-section__bg-block"></div>

  <div class="reviews-section__container">
    {%- comment -%} Heading {%- endcomment -%}
    {% if section.settings.heading != blank %}
      <h2 class="reviews-section__heading">{{ section.settings.heading }}</h2>
    {% endif %}

    {%- comment -%} View All Button {%- endcomment -%}
    {% if section.settings.view_all_url != blank %}
      <a href="{{ section.settings.view_all_url }}" class="reviews-section__view-all">
        <span>{{ section.settings.view_all_text | default: 'VIEW ALL' }}</span>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="6"
          height="12"
          viewBox="0 0 6 12"
          fill="none">
          <path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M5.07845 6.35532L0.249977 11.1838L-0.707153 10.2267L3.47845 6.00032L-0.707153 1.77398L0.249977 0.816849L5.07845 5.64532C5.17219 5.73922 5.22507 5.86727 5.22507 6.00032C5.22507 6.13337 5.17219 6.26142 5.07845 6.35532Z"
            fill="#3E2027" />
        </svg>
      </a>
    {% endif %}

    {%- comment -%} Reviews Carousel {%- endcomment -%}
    <div class="reviews-section__carousel" data-reviews-carousel>
      <div class="reviews-section__track" data-reviews-track>
        {%- comment -%} Yotpo Reviews Container {%- endcomment -%}
        <div class="reviews-section__yotpo-container" id="yotpo-reviews-{{ section.id }}">
          {%- comment -%} Yotpo widget will load here {%- endcomment -%}
          <div
            class="yotpo yotpo-reviews-carousel"
            data-appkey="{{ section.settings.yotpo_app_key }}"
            data-domain="{{ shop.domain }}"
            data-product-id="{{ section.settings.product_id | default: 'site' }}"
            data-name="{{ shop.name }}"
            data-url="{{ shop.url }}"></div>
        </div>

        {%- comment -%} Fallback/Sample Reviews (if Yotpo not loaded) {%- endcomment -%}
        {% if section.blocks.size > 0 %}
          <div class="reviews-section__cards" data-reviews-cards>
            {% for block in section.blocks %}
              {% if block.type == 'review' %}
                <div class="reviews-section__card" {{ block.shopify_attributes }}>
                  <div class="reviews-section__card-header">
                    <p class="reviews-section__card-name">{{ block.settings.reviewer_name }}</p>
                    <p class="reviews-section__card-date">{{ block.settings.review_date }}</p>
                  </div>
                  <p class="reviews-section__card-text">{{ block.settings.review_text }}</p>
                  <div class="reviews-section__card-stars">
                    {% for i in (1..5) %}
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="15"
                        height="15"
                        viewBox="0 0 15 15"
                        fill="none">
                        <path d="M7.14446 1.23193C7.17732 1.16229 7.22809 1.10368 7.29104 1.06207C7.35399 1.02046 7.42659 0.998291 7.50068 0.998291C7.57476 0.998291 7.64736 1.02046 7.71031 1.06207C7.77326 1.10368 7.82403 1.16229 7.85689 1.23193L9.58923 5.13593C9.70335 5.40213 9.87182 5.63668 10.0802 5.82459C10.2885 6.0125 10.5305 6.14902 10.7904 6.22426L14.6595 7.31984C14.733 7.33998 14.8019 7.37746 14.8586 7.42925C14.9153 7.48103 14.9586 7.54548 14.9851 7.61745C15.0116 7.68941 15.0206 7.76665 15.0114 7.84268C15.0023 7.91871 14.9751 7.99125 14.932 8.05382L12.0782 11.9851C11.8935 12.2399 11.7552 12.5305 11.6704 12.8403C11.5856 13.1501 11.5556 13.4734 11.582 13.7951L12.2741 18.0107C12.2944 18.1376 12.2765 18.2679 12.2226 18.3843C12.1686 18.5008 12.0808 18.5982 11.9707 18.6644C11.8607 18.7306 11.7334 18.7627 11.6043 18.7565C11.4752 18.7503 11.3512 18.7062 11.2478 18.6296L7.74051 16.2915C7.51192 16.1368 7.25803 16.0568 7.00029 16.0568C6.74256 16.0568 6.48867 16.1368 6.26007 16.2915L2.75805 18.6296C2.6547 18.7061 2.53078 18.7501 2.40177 18.7563C2.27276 18.7624 2.14562 18.7303 2.03562 18.6641C1.92563 18.5979 1.83795 18.5006 1.784 18.3842C1.73004 18.2678 1.71218 18.1376 1.73243 18.0107L2.4229 13.7968C2.44941 13.4746 2.41947 13.1508 2.33462 12.8406C2.24977 12.5304 2.11163 12.2395 1.92679 11.9851L-0.926994 8.0555C-0.970246 7.99302 -1.00337 7.92048 -1.01243 7.84442C-1.02149 7.76836 -1.01222 7.69108 -0.985641 7.61905C-0.959062 7.54702 -0.915602 7.4825 -0.858849 7.43063C-0.802097 7.37875 -0.732986 7.34119 -0.659492 7.32096L3.2015 6.22426C3.46039 6.14932 3.70244 6.01294 3.91091 5.82501C4.11939 5.63708 4.28798 5.40237 4.40229 5.13593L6.13229 1.23193C6.16515 1.16229 6.21592 1.10368 6.27887 1.06207C6.34182 1.02046 6.41442 0.998291 6.48851 0.998291C6.56259 0.998291 6.63519 1.02046 6.69814 1.06207C6.76109 1.10368 6.81186 1.16229 6.84472 1.23193H7.14446Z" fill="#3E2027" />
                      </svg>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>

    {%- comment -%} Navigation Arrows {%- endcomment -%}
    <button
      type="button"
      class="reviews-section__arrow reviews-section__arrow--prev"
      aria-label="{{ 'general.previous' | t }}"
      data-reviews-prev>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="10"
        height="20"
        viewBox="0 0 10 20"
        fill="none">
        <path
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M9.64159 10.2957L4.81312 15.1242L3.85599 14.167L7.39999 10.0007L3.85599 5.83431L4.81312 4.87718L9.64159 9.70565C9.73533 9.79955 9.78821 9.92761 9.78821 10.0607C9.78821 10.1937 9.73533 10.3218 9.64159 10.4157V10.2957Z"
          fill="#3E2027" />
      </svg>
    </button>

    <button
      type="button"
      class="reviews-section__arrow reviews-section__arrow--next"
      aria-label="{{ 'general.next' | t }}"
      data-reviews-next>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="10"
        height="20"
        viewBox="0 0 10 20"
        fill="none">
        <path
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M0.358413 10.2957L5.18688 15.1242L6.14401 14.167L2.60001 10.0007L6.14401 5.83431L5.18688 4.87718L0.358413 9.70565C0.264674 9.79955 0.211792 9.92761 0.211792 10.0607C0.211792 10.1937 0.264674 10.3218 0.358413 10.4157V10.2957Z"
          fill="#3E2027" />
      </svg>
    </button>
  </div>
</div>

{% stylesheet %}
  .reviews-section {
    background-color: #FFF7EA;
    padding: 0;
    position: relative;
    overflow: hidden;
  }

  /* Background Color Block - Full width, positioned absolutely */
  .reviews-section__bg-block {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 500px;
    background-color: #FCF0D2;
    z-index: 0;
  }

  .reviews-section__container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 90px 40px 100px;
    position: relative;
    z-index: 1;
  }

  /* Heading */
  .reviews-section__heading {
    font-family: var(--font-alyona);
    font-size: 70px;
    font-weight: 400;
    line-height: 1;
    color: #3E2027;
    margin: 0 0 140px;
    position: relative;
  }

  /* View All Button */
  .reviews-section__view-all {
    position: absolute;
    right: 40px;
    top: 93px;
    display: flex;
    align-items: center;
    gap: 15px;
    font-family: var(--font-sweet-sans);
    font-weight: 500;
    font-size: 18px;
    line-height: normal;
    letter-spacing: -0.18px;
    text-transform: uppercase;
    color: #3E2027;
    text-decoration: none;
    z-index: 2;
    transition: opacity 0.2s ease
    , transform 0.2s ease;
  }

  .reviews-section__view-all:hover {
    opacity: 0.8;
    transform: translateY(-1px);
  }

  .reviews-section__view-all svg {
    width: 6px;
    height: 12px;
    flex-shrink: 0;
  }

  /* Carousel */
  .reviews-section__carousel {
    position: relative;
    overflow: hidden;
  }

  .reviews-section__track {
    position: relative;
    width: 100%;
  }

  /* Hide Yotpo default container, use custom cards */
  .reviews-section__yotpo-container {
    display: none;
  }

  /* Reviews Cards */
  .reviews-section__cards {
    display: flex;
    gap: 35px;
    transition: transform 0.4s ease;
    will-change: transform;
  }

  /* Individual Review Card */
  .reviews-section__card {
    flex: 0 0 367px;
    width: 367px;
    height: 150px;
    border-left: 1px solid #3E2027;
    padding: 10px 0 10px 30px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    background-color: transparent;
  }

  /* Card Header - Name and Date */
  .reviews-section__card-header {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .reviews-section__card-name {
    font-family: var(--font-sweet-sans);
    font-weight: 500;
    font-size: 18px;
    line-height: normal;
    letter-spacing: -0.18px;
    text-transform: uppercase;
    color: #3E2027;
    margin: 0;
    white-space: nowrap;
  }

  .reviews-section__card-date {
    font-family: var(--font-jokker);
    font-size: 14px;
    line-height: 1.5;
    color: #3E2027;
    opacity: 0.4;
    margin: 0;
    white-space: nowrap;
  }

  /* Card Review Text */
  .reviews-section__card-text {
    font-family: var(--font-jokker);
    font-size: 16px;
    line-height: 1.5;
    color: #3E2027;
    margin: 0;
    flex: 1;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }

  /* Star Rating */
  .reviews-section__card-stars {
    display: flex;
    gap: 5.09px;
    align-items: center;
  }

  .reviews-section__card-stars svg {
    width: 15px;
    height: 15px;
    flex-shrink: 0;
  }

  /* Navigation Arrows - Positioned relative to the cards */
  .reviews-section__arrow {
    position: absolute;
    top: 295px;
    width: 10px;
    height: 20px;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 0;
    z-index: 3;
    transition: opacity 0.2s ease
    , transform 0.2s ease;
  }

  .reviews-section__arrow:hover {
    opacity: 0.7;
    transform: translateY(-1px);
  }

  .reviews-section__arrow:active {
    opacity: 0.5;
    transform: translateY(0);
  }

  .reviews-section__arrow:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .reviews-section__arrow--prev {
    left: 30px;
  }

  .reviews-section__arrow--next {
    right: 30px;
  }

  .reviews-section__arrow svg {
    width: 100%;
    height: 100%;
    display: block;
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .reviews-section__container {
      padding: 70px 24px 80px;
    }

    .reviews-section__heading {
      margin-bottom: 100px;
    }

    .reviews-section__view-all {
      right: 24px;
      top: 73px;
    }

    .reviews-section__card {
      flex: 0 0 340px;
      width: 340px;
    }

    .reviews-section__cards {
      gap: 25px;
    }

    .reviews-section__arrow {
      top: 235px;
    }
  }

  @media (max-width: 768px) {
    .reviews-section__bg-block {
      height: 350px;
    }

    .reviews-section__container {
      padding: 50px 16px 60px;
    }

    .reviews-section__heading {
      font-size: 50px;
      margin-bottom: 70px;
    }

    .reviews-section__view-all {
      right: 16px;
      top: 53px;
      font-size: 16px;
      gap: 10px;
    }

    .reviews-section__card {
      flex: 0 0 280px;
      width: 280px;
      height: auto;
      min-height: 140px;
      padding: 10px 0 10px 20px;
    }

    .reviews-section__card-name {
      font-size: 16px;
    }

    .reviews-section__card-date {
      font-size: 12px;
    }

    .reviews-section__card-text {
      font-size: 14px;
    }

    .reviews-section__cards {
      gap: 20px;
    }

    .reviews-section__arrow {
      top: 180px;
    }

    .reviews-section__arrow--prev {
      left: 16px;
    }

    .reviews-section__arrow--next {
      right: 16px;
    }
  }

  @media (max-width: 480px) {
    .reviews-section__heading {
      font-size: 40px;
    }

    .reviews-section__card {
      flex: 0 0 250px;
      width: 250px;
      padding: 10px 0 10px 16px;
    }

    .reviews-section__card-name {
      font-size: 14px;
    }

    .reviews-section__card-text {
      font-size: 13px;
    }
  }
{% endstylesheet %}

{% javascript %}
  class ReviewsCarousel {
    constructor(container) {
      this.container = container;
      this.track = container.querySelector('[data-reviews-track]');
      this.cards = container.querySelectorAll('.reviews-section__card');
      this.prevBtn = container.querySelector('[data-reviews-prev]');
      this.nextBtn = container.querySelector('[data-reviews-next]');
      this.currentIndex = 0;
      this.cardsToShow = this.getCardsToShow();

      if (this.cards.length<= this.cardsToShow) {
        this.hideArrows();
        return;
      }

      this.init();
      this.setupResizeHandler();
    }

    init() {
      this.updateCarousel();
      this.prevBtn?.addEventListener('click', () => this.prev()) 
      
      this.nextBtn ?. addEventListener('click', () => this.next());

// Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') 
          this.prev();
        
        if (e.key === 'ArrowRight') 
          this.next();
        
      });
    }

    getCardsToShow() {
      const width = window.innerWidth;
      if (width <= 480) return1;
      
      if (width <= 768) return2;
      
      if (width <= 1200) return3;
      
      return 3;
    }

    updateCarousel() {
      const cardsContainer = this.container.querySelector('[data-reviews-cards]');
      if (! cardsContainer) return;
      

      const cardWidth = this.cards[0].offsetWidth;
      const gap = parseFloat(getComputedStyle(cardsContainer).gap);
      const offset = -(this.currentIndex * (cardWidth + gap));

      cardsContainer.style.transform = `translateX(${offset}px)`;

// Update button states
      if (this.prevBtn) {
        this.prevBtn.disabled = this.currentIndex === 0;
      }
      if (this.nextBtn) {
        this.nextBtn.disabled = this.currentIndex >= this.cards.length - this.cardsToShow;
      }
    }

    next() {
      if (this.currentIndex<this.cards.length - this.cardsToShow) {
        this.currentIndex++;
        this.updateCarousel();
      }
    }

    prev() {
      if (this.currentIndex> 0) {
        this.currentIndex --;
        this.updateCarousel();
      }
    }

    hideArrows() {
      if (this.prevBtn) 
        this.prevBtn.style.display = 'none';
      
      if (this.nextBtn) 
        this.nextBtn.style.display = 'none';
      
    }

    setupResizeHandler() {
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          const newCardsToShow = this.getCardsToShow();
          if (newCardsToShow !== this.cardsToShow) {
            this.cardsToShow = newCardsToShow;
            this.currentIndex = Math.min(this.currentIndex, Math.max(0, this.cards.length - this.cardsToShow));
            this.updateCarousel();
          }
        }, 150);
      });
    }
  }

// Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initReviews);
  } else {
    initReviews();
  }

  function initReviews() {
    const reviewsSection = document.querySelector('[data-reviews-carousel]');
    if (reviewsSection) {
      new ReviewsCarousel(reviewsSection);
    }
  }

// Yotpo integration - Load Yotpo script and initialize
  (function() {
    const yotpoAppKey = document.querySelector('.yotpo-reviews-carousel') ?. getAttribute('data-appkey');

    if (yotpoAppKey && typeof yotpo === 'undefined') {
      const script = document.createElement('script');
      script.type = 'text/javascript';
      script.async = true;
      script.src = `//staticw2.yotpo.com/${yotpoAppKey}/widget.js`;
      document.head.appendChild(script);
    } else if (typeof yotpo !== 'undefined') { // Yotpo already loaded, refresh widgets
      yotpo.refreshWidgets();
    }
  })();
{% endjavascript %}

{% schema %}
  {
    "name": "t:general.reviews",
    "class": "reviews-section-wrapper",
    "settings": [
      {
        "type": "header",
        "content": "t:sections.reviews.content_header"
      },
      {
        "type": "text",
        "id": "heading",
        "label": "t:labels.heading",
        "default": "Reviews"
      },
      {
        "type": "header",
        "content": "t:sections.reviews.view_all_header"
      },
      {
        "type": "text",
        "id": "view_all_text",
        "label": "t:labels.view_all_text",
        "default": "VIEW ALL"
      }, {
        "type": "url",
        "id": "view_all_url",
        "label": "t:labels.view_all_url",
        "info": "t:sections.reviews.view_all_info"
      }, {
        "type": "header",
        "content": "t:sections.reviews.yotpo_header"
      }, {
        "type": "text",
        "id": "yotpo_app_key",
        "label": "t:labels.yotpo_app_key",
        "info": "t:sections.reviews.yotpo_app_key_info"
      }, {
        "type": "product",
        "id": "product_id",
        "label": "t:labels.product",
        "info": "t:sections.reviews.product_info"
      }
    ],
    "blocks": [
      {
        "type": "review",
        "name": "t:blocks.review.name",
        "settings": [
          {
            "type": "text",
            "id": "reviewer_name",
            "label": "t:labels.reviewer_name",
            "default": "Reviewer Name"
          }, {
            "type": "text",
            "id": "review_date",
            "label": "t:labels.review_date",
            "default": "06/2025"
          }, {
            "type": "textarea",
            "id": "review_text",
            "label": "t:labels.review_text",
            "default": "This product exceeded my expectations!"
          }
        ]
      }
    ],
    "presets": [
      {
        "name": "t:general.reviews",
        "blocks": [
          {
            "type": "review",
            "settings": {
              "reviewer_name": "Mia T.",
              "review_date": "06/2025",
              "review_text": "My husband literally said, 'Wait, why do you smell like nothing?' Best compliment ever."
            }
          }, {
            "type": "review",
            "settings": {
              "reviewer_name": "Lucas M.",
              "review_date": "06/2025",
              "review_text": "I've tried every natural deo out there â€” this is the first thing that actually works."
            }
          }, {
            "type": "review",
            "settings": {
              "reviewer_name": "Mia T.",
              "review_date": "06/2025",
              "review_text": "Didn't expect a pre-deodorant to change my life, but here we are."
            }
          }
        ]
      }
    ]
  }
{% endschema %}