{% doc %}
  Renders a product card for the collection grid.

  @param {product} product - The product to display
  @param {string} [card_width] - Card width: "1" (single) or "2" (double), default "1"
  @param {boolean} [show_badge] - Whether to show a badge
  @param {string} [badge_text] - Text for the badge
  @param {boolean} [lazy_load] - Whether to lazy load images, default true
{% enddoc %}

{%- liquid
  assign card_width = card_width | default: '1'
  assign is_wide = false
  if card_width == '2'
    assign is_wide = true
  endif

  assign lazy_load = lazy_load | default: true
  assign loading_attr = 'lazy'
  if lazy_load == false
    assign loading_attr = 'eager'
  endif

  assign has_compare_price = false
  if product.compare_at_price > product.price
    assign has_compare_price = true
  endif

  assign short_description = product.metafields.custom.short_description | default: product.description | strip_html | truncate: 120

  comment
    Video metafield - expects a video file reference
    Set up in Shopify Admin: Settings > Custom data > Products > Add definition
    Name: Card Video, Namespace: custom, Key: card_video, Type: File (video)
  endcomment
  assign card_video = product.metafields.custom.card_video
  assign has_video = false
  if card_video != blank
    assign has_video = true
  endif
-%}

<article class="product-card{% if is_wide %} product-card--wide{% endif %}{% if has_video %} product-card--has-video{% endif %}" data-product-card>
  <div class="product-card__image-wrapper">
    {%- if show_badge and badge_text != blank -%}
      <span class="product-card__badge" aria-hidden="true">{{ badge_text | escape }}</span>
    {%- endif -%}

    <a href="{{ product.url }}" class="product-card__image-link" aria-label="{{ product.title }}">
      <div class="product-card__image-container">
        {%- if is_wide and product.images.size > 1 -%}
          <div class="product-card__images-stack">
            {%- for image in product.images limit: 2 -%}
              <div class="product-card__stacked-image" style="--stack-index: {{ forloop.index0 }}">
                {{ image | image_url: width: 400 | image_tag:
                  loading: loading_attr,
                  class: 'product-card__img',
                  alt: image.alt | default: product.title,
                  width: 400,
                  height: 600,
                  style: 'aspect-ratio: 400/600'
                }}
              </div>
            {%- endfor -%}
          </div>
        {%- else -%}
          {%- if product.featured_image -%}
            {{ product.featured_image | image_url: width: 500 | image_tag:
              loading: loading_attr,
              class: 'product-card__img product-card__img--single',
              alt: product.featured_image.alt | default: product.title,
              width: 247,
              height: 370,
              style: 'aspect-ratio: 247/370'
            }}
          {%- else -%}
            <div class="product-card__placeholder">
              {{ 'product-1' | placeholder_svg_tag: 'product-card__placeholder-svg' }}
            </div>
          {%- endif -%}
        {%- endif -%}
      </div>

      {%- if has_video -%}
        <div class="product-card__video-container">
          <video
            class="product-card__video"
            muted
            loop
            playsinline
            preload="none"
            aria-hidden="true"
            data-product-video>
            <source src="{{ card_video | file_url }}" type="{{ card_video.media_type | default: 'video/mp4' }}">
          </video>
        </div>
      {%- endif -%}
    </a>

    <div class="product-card__actions">
      {%- form 'product', product, class: 'product-card__form' -%}
        {%- assign selected_variant = product.selected_or_first_available_variant -%}
        <input type="hidden" name="id" value="{{ selected_variant.id }}">
        <button
          type="submit"
          name="add"
          class="product-card__action-btn product-card__action-btn--add"
          aria-label="{{ 'products.add_to_cart' | t }}: {{ product.title }}"
          {% unless selected_variant.available %}disabled aria-disabled="true" aria-label="{{ product.title }} - {{ 'products.sold_out' | t }}"{% endunless %}>
          <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M0.75 7.75H14.75M7.75 0.75V14.75" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
          <span>{{ 'products.add_to_cart' | t }}</span>
        </button>
      {%- endform -%}
      <a href="{{ product.url }}" class="product-card__action-btn product-card__action-btn--buy" aria-label="{{ 'products.buy_now' | t }}: {{ product.title }}">
        {{ 'products.buy_now' | t }}
      </a>
    </div>
  </div>

  <div class="product-card__content">
    <div class="product-card__header">
      <h3 class="product-card__title">
        <a href="{{ product.url }}" class="product-card__title-link">{{ product.title }}</a>
      </h3>
      <div class="product-card__price">
        {%- if has_compare_price -%}
          <s class="product-card__compare-price">
            <span class="visually-hidden">{{ 'products.regular_price' | t }}:</span>
            {{ product.compare_at_price | money }}
          </s>
        {%- endif -%}
        <span class="product-card__current-price{% if has_compare_price %} product-card__current-price--sale{% endif %}">
          {%- if has_compare_price -%}
            <span class="visually-hidden">{{ 'products.sale_price' | t }}:</span>
          {%- endif -%}
          {{ product.price | money }}
        </span>
      </div>
    </div>
    {%- if short_description != blank -%}
      <p class="product-card__description">{{ short_description }}</p>
    {%- endif -%}
  </div>
</article>
